#!/bin/bash
#
# Pre-commit hook: Run unit tests
#
# This hook ensures unit tests pass before committing (if gtest available)
#

set -e

# Get repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Check for g++ compiler
if ! command -v g++ &> /dev/null; then
    echo "WARNING: g++ not found. Skipping pre-commit checks."
    exit 0
fi

echo "=== Pre-commit: Running tests ==="

# Run unit tests (if gtest is available)
cd "$REPO_ROOT/tests"

# Try to build - if gtest is missing, skip tests with warning
if make 2>&1 | grep -q "gtest/gtest.h: No such file"; then
    echo "WARNING: Google Test not installed. Skipping unit tests."
    echo "  Install with: sudo apt-get install libgtest-dev"
else
    if [ -f ./run_tests ]; then
        if ! ./run_tests; then
            echo ""
            echo "ERROR: Unit tests failed. Commit aborted."
            echo "Fix the failing tests and try again."
            exit 1
        fi
        echo "Unit tests passed."
    fi
fi

echo ""
echo "=== Pre-commit checks passed ==="
exit 0
